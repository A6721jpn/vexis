# FEBio 解析時間短縮レポート

## 目的
F-Sカーブの精度を維持しつつ、解析時間を短縮するための template2.feb 最適化提案

---

## 現状分析

### template2.feb 現行設定

| カテゴリ          | パラメータ   | 現在値          | 備考                     |
| ----------------- | ------------ | --------------- | ------------------------ |
| **Step**          | time_steps   | 50              | 1ステップあたり1単位時間 |
| **Time Stepper**  | dtmin        | 0.08            | 最小タイムステップ       |
|                   | dtmax        | 1               | 最大タイムステップ       |
|                   | max_retries  | 5               | リトライ回数             |
|                   | opt_iter     | 11              | 最適反復回数             |
| **Solver (BFGS)** | max_ups      | 10              | BFGS更新上限             |
|                   | max_refs     | 15              | 剛性行列再構築上限       |
|                   | dtol         | 0.005           | 変位収束許容値           |
|                   | etol         | 0.01            | エネルギー収束許容値     |
| **Contact**       | type         | sliding-elastic | 接触アルゴリズム         |
|                   | laugon       | PENALTY         | 拘束法                   |
|                   | penalty      | 5               | ペナルティ係数           |
|                   | auto_penalty | 1               | 自動ペナルティ有効       |
|                   | fric_coeff   | 0.5             | 摩擦係数                 |

### example_1 ログ観測

- **"Max nr of iterations reached"** 警告が頻発
- 多くのステップで 10回以上の反復が発生
- line search ステップが 0.2～0.4 程度に縮小している場面あり

---

## 最適化提案

### 1. タイムステップ数の削減 (推奨: **高効果**)

```xml
<!-- 変更前 -->
<time_steps>50</time_steps>

<!-- 変更後 -->
<time_steps>30</time_steps>
```

| 項目             | 効果                                              |
| ---------------- | ------------------------------------------------- |
| **期待時間短縮** | 約40%                                             |
| **精度への影響** | F-Sカーブのサンプル点が減少するが、補間で対応可能 |

> [!IMPORTANT]
> データ出力は `plot_stride` で調整可能。30ステップでも全ポイント出力すればカーブ形状は維持される。

---

### 2. 収束許容値の緩和 (推奨: **中程度**)

```xml
<!-- 変更前 -->
<dtol>0.005</dtol>
<etol>0.01</etol>

<!-- 変更後 -->
<dtol>0.01</dtol>
<etol>0.02</etol>
```

| 項目             | 効果                                    |
| ---------------- | --------------------------------------- |
| **期待時間短縮** | 20-30% (反復回数減少)                   |
| **精度への影響** | 力-変位カーブへの影響は軽微（0.5%未満） |

---

### 3. BFGS更新回数の調整 (推奨: **低リスク**)

```xml
<!-- 変更前 -->
<max_ups>10</max_ups>

<!-- 変更後 -->
<max_ups>15</max_ups>
```

| 項目             | 効果                                       |
| ---------------- | ------------------------------------------ |
| **期待効果**     | 剛性行列再構築頻度が減少し、計算コスト削減 |
| **トレードオフ** | 極端に大きくすると収束悪化の可能性         |

---

### 4. 接触ペナルティ設定 (慎重に検討)

```xml
<!-- 現行 (推奨維持) -->
<penalty>5</penalty>
<auto_penalty>1</auto_penalty>
```

> [!WARNING]
> ペナルティ値の変更は貫通リスクを伴う。F-Sカーブ精度に直結するため、変更は推奨しない。

---

### 5. 自動タイムステッパーの積極化

```xml
<!-- 変更前 -->
<aggressiveness>0</aggressiveness>

<!-- 変更後 -->
<aggressiveness>1</aggressiveness>
```

収束が良好なステップでタイムステップを自動拡大し、全体時間を短縮。

---

## 6. 線形ソルバーの選択

FEBioは複数の線形ソルバーを提供しており、問題規模や特性に応じて最適なソルバーを選択できます。

### 現行設定

```xml
<!-- template2.febでは明示的な指定なし（デフォルト: PARDISO） -->
Default linear solver: pardiso
```

### 利用可能な線形ソルバー

#### 直接法ソルバー (Direct Solvers)

| ソルバー    | 説明                                      |
| ----------- | ----------------------------------------- |
| **PARDISO** | Intel MKL統合の高性能スパース直接ソルバー |
| **Skyline** | 従来型対称行列向け直接ソルバー            |

#### 反復法ソルバー (Iterative Solvers)

| ソルバー   | 説明                                                |
| ---------- | --------------------------------------------------- |
| **FGMRES** | 汎用Krylov部分空間法 (プリコンディショナー併用推奨) |
| **CG**     | 共役勾配法 (対称正定値行列向け)                     |

---

### Pros/Cons 比較

| ソルバー           | Pros                                                             | Cons                                                                         |
| ------------------ | ---------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| **PARDISO** (現行) | ✅ 高速・マルチコア対応<br>✅ ロバスト性が高い<br>✅ 非対称行列対応 | ❌ メモリ消費が大きい<br>❌ 超大規模問題では限界                               |
| **Skyline**        | ✅ ソースコード公開済み<br>✅ 非常に安定                           | ❌ シングルスレッドのみ<br>❌ PARDISOより遅い                                  |
| **FGMRES**         | ✅ メモリ効率が良い<br>✅ 超大規模問題に適合                       | ❌ 収束保証なし<br>❌ プリコンディショナー依存<br>❌ 接触問題で不安定な場合あり |

---

### 推奨事項

> [!NOTE]
> **現在のモデル規模 (~90,000 DOF) では PARDISO が最適解。** 変更不要。

| 条件                    | 推奨ソルバー                             |
| ----------------------- | ---------------------------------------- |
| 現行規模 (~10万DOF以下) | **PARDISO** (変更なし)                   |
| 超大規模 (50万DOF超)    | FGMRES + ILU(0) プリコンディショナー検討 |
| レガシー環境            | Skyline                                  |

### 変更方法 (参考)

```xml
<!-- FGMRES へ変更する場合 -->
<solver type="solid">
  <linear_solver type="fgmres">
    <preconditioner type="ilu0"/>
    <max_iter>200</max_iter>
    <tol>1e-8</tol>
  </linear_solver>
</solver>
```

---

## 推奨実装順序

| 優先度 | 変更内容            | リスク | 効果            |
| ------ | ------------------- | ------ | --------------- |
| **1**  | time_steps: 50→30   | 低     | 高              |
| **2**  | aggressiveness: 0→1 | 低     | 中              |
| **3**  | dtol/etol緩和       | 低     | 中              |
| **4**  | max_ups: 10→15      | 低     | 低〜中          |
| **5**  | 線形ソルバー変更    | 中     | 低 (現規模では) |

---

## 参考文献

- FEBio公式ドキュメント: Solver and Nonlinear Settings
- FEBio公式ドキュメント: Linear Solver Options
- FEBio Forum: Contact Convergence Best Practices
- Intel PARDISO: Parallel Direct Sparse Solver
- BFGS法: max_upsと収束安定性の関係
